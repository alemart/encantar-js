/*!
 * babylon.js plugin for encantar.js
 * @author Alexandre Martins <alemartf(at)gmail.com> (https://github.com/alemart/encantar-js)
 * @license LGPL-3.0-or-later
 */__THIS_PLUGIN_HAS_BEEN_TESTED_WITH__({"encantar.js":{version:"0.4.5"},"babylon.js":{version:"7.38.0"}});class ARDemo{startSession(){throw new Error("Abstract method")}init(){return Promise.resolve()}update(){}release(){}preload(){return Promise.resolve()}get ar(){return this._ar}constructor(){this._ar=null}}class ARUtils{convertVector2(e){return new BABYLON.Vector2(e.x,e.y)}convertVector3(e){return new BABYLON.Vector3(e.x,e.y,e.z)}convertQuaternion(e){return new BABYLON.Quaternion(e.x,e.y,e.z,e.w)}convertRay(e){const c=this.convertVector3(e.origin),o=this.convertVector3(e.direction);return new BABYLON.Ray(c,o)}}class ARSystem{get session(){return this._session}get frame(){return this._frame}get viewer(){return this._viewer}get pointers(){return this._pointers}get root(){return this._root}get scene(){return this._scene}get camera(){return this._camera}get engine(){return this._engine}get utils(){return this._utils}constructor(){this._session=null,this._frame=null,this._viewer=null,this._pointers=[],this._origin=null,this._root=null,this._scene=null,this._camera=null,this._engine=null,this._utils=new ARUtils}}function encantar(i){const e=new ARSystem,c=new BABYLON.Matrix().copyFromFloats(1,0,0,0,0,1,0,0,0,0,-1,0,0,0,0,1);function o(t,n){e._frame=n,s(n),e._engine.beginFrame(),i.update(),e._scene.render(!1),e._engine.endFrame(),e._session.requestAnimationFrame(o)}function s(t){let n=!1;e._viewer=null,e._pointers.length=0;for(const r of t.results)if(r.of("image-tracker")){if(r.trackables.length>0){const a=r.trackables[0],u=r.viewer.view.projectionMatrix,h=r.viewer.pose.viewMatrix,g=a.pose.transform.matrix;l(u,h,g),e._origin.setEnabled(!0),e._viewer=r.viewer,n=!0}}else r.of("pointer-tracker")&&r.trackables.length>0&&e._pointers.push.apply(e._pointers,r.trackables);n||e._origin.setEnabled(!1)}function l(t,n,r){e._scene.useRightHandedSystem?e._camera.freezeProjectionMatrix(_(t)):e._camera.freezeProjectionMatrix(_(t).multiply(c)),e._camera.setViewMatrix(_(n)),_(r).decomposeToTransformNode(e._origin)}function _(t){return new BABYLON.Matrix().fromArray(t.read())}return Promise.resolve().then(()=>i.preload()).then(()=>i.startSession()).then(t=>(i._ar=e,e._session=t,BABYLON.Engine.prototype.resize=function(n=!1){const r=t.viewport.virtualSize;this.setSize(r.width,r.height,n)},e._engine=new BABYLON.Engine(t.viewport.canvas,!1,{premultipliedAlpha:!0}),e._scene=new BABYLON.Scene(e._engine),e._scene.useRightHandedSystem=!0,e._scene.clearColor=new BABYLON.Color4(0,0,0,0),e._scene._inputManager._updatePointerPosition=function(n){const r=this._scene.getEngine(),a=r.getInputElementClientRect();a&&(this._pointerX=(n.clientX-a.left)*(r.getRenderWidth()/a.width),this._pointerY=(n.clientY-a.top)*(r.getRenderHeight()/a.height),this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)},e._origin=new BABYLON.TransformNode("ar-origin",e._scene),e._root=new BABYLON.TransformNode("ar-root",e._scene),e._root.parent=e._origin,e._origin.setEnabled(!1),e._camera=new BABYLON.Camera("ar-camera",BABYLON.Vector3.Zero(),e._scene),e._camera._tmpQuaternion=BABYLON.Quaternion.Identity(),e._camera._customViewMatrix=BABYLON.Matrix.Identity(),e._camera._getViewMatrix=function(){return this._customViewMatrix},e._camera.setViewMatrix=function(n){this._customViewMatrix.copyFrom(n),this.getViewMatrix(!0),this.getWorldMatrix().decompose(void 0,this._tmpQuaternion,this.position),BABYLON.Axis.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector),this._globalPosition.copyFrom(this.position)},t.addEventListener("end",n=>{e._origin.setEnabled(!1),e._viewer=null,e._frame=null,e._pointers.length=0}),t.viewport.addEventListener("resize",n=>{e._engine.resize()}),Promise.resolve().then(()=>i.init()).then(()=>(t.addEventListener("end",n=>{i.release()}),t.requestAnimationFrame(o),e)).catch(n=>{throw t.end(),n}))).catch(t=>{throw console.error(t),t})}function __THIS_PLUGIN_HAS_BEEN_TESTED_WITH__(i){window.addEventListener("load",()=>{try{AR,BABYLON;const e={"encantar.js":AR.version.replace(/-.*$/,""),"babylon.js":BABYLON.Engine.Version},c=(o,s,l)=>s!=l?console.warn(`


WARNING

This plugin has been tested with ${o} version ${s}. The version in use is ${l}. Usage of ${o} version ${s} is recommended instead.


`):void 0;for(const[o,s]of Object.entries(i))c(o,s.version,e[o])}catch(e){alert(e.message)}})}
